name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
    paths:
      - "src/**"
      - "build_configs/**"
      - ".github/workflows/build.yml"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "build_configs/**"
      - ".github/workflows/build.yml"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  APP_VERSION: "0.1.0"

jobs:
  build:
    name: Build (${{ matrix.os }} - ${{ matrix.build_variant }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, windows-2025, macos-15]
        build_variant: [standard, ai]
        exclude:
          - os: windows-2025
            build_variant: ai
    env:
      ARTIFACT_NAME: ""
      ARTIFACT_FILE: ""
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install core dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Install AI dependencies
        if: matrix.build_variant == 'ai'
        run: python -m pip install -r requirements-ai.txt

      - name: Install PyInstaller
        run: python -m pip install pyinstaller

      - name: Install icon tooling (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y inkscape imagemagick fuse

      - name: Install icon tooling (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install --cask inkscape
          brew install imagemagick

      - name: Install icon tooling (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install -y inkscape imagemagick

      - name: Generate icons (POSIX)
        if: runner.os != 'Windows'
        run: bash tools/build_icons.sh

      - name: Generate icons (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./tools/build_icons.ps1

      - name: Run PyInstaller
        run: |
          if [ "${{ matrix.build_variant }}" = "ai" ]; then
            pyinstaller build_configs/mp3paramidi-ai.spec
          else
            pyinstaller build_configs/mp3paramidi.spec
          fi
        shell: bash
        if: runner.os != 'Windows'

      - name: Run PyInstaller (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ('${{ matrix.build_variant }}' -eq 'ai') {
            pyinstaller build_configs/mp3paramidi-ai.spec
          } else {
            pyinstaller build_configs/mp3paramidi.spec
          }

      - name: Package AppImage
        if: runner.os == 'Linux'
        env:
          APPIMAGE_EXTRACT_AND_RUN: "1"
        run: |
          bash build_configs/linux/build_appimage.sh "dist/mp3paramidi-${{ matrix.build_variant }}" dist "${{ env.APP_VERSION }}" "${{ matrix.build_variant }}"
          if [ "${{ matrix.build_variant }}" = "ai" ]; then
            variant_label="AI"
          else
            variant_label="Standard"
          fi
          artifact_file="dist/MP3paraMIDI-v${{ env.APP_VERSION }}-Linux-${variant_label}-x86_64.AppImage"
          echo "ARTIFACT_FILE=${artifact_file}" >> "$GITHUB_ENV"
          echo "ARTIFACT_NAME=MP3paraMIDI-${{ matrix.os }}-${{ matrix.build_variant }}" >> "$GITHUB_ENV"

      - name: Package macOS artifact
        if: runner.os == 'macOS'
        run: |
          if [ "${{ matrix.build_variant }}" = "ai" ]; then
            variant_label="AI"
          else
            variant_label="Standard"
          fi
          app_path="dist/mp3paramidi.app"
          dmg_path="dist/MP3paraMIDI-v${{ env.APP_VERSION }}-macOS-${variant_label}.dmg"
          hdiutil create -volname "MP3paraMIDI" -srcfolder "$app_path" -ov -format UDZO "$dmg_path"
          echo "ARTIFACT_FILE=${dmg_path}" >> "$GITHUB_ENV"
          echo "ARTIFACT_NAME=MP3paraMIDI-${{ matrix.os }}-${{ matrix.build_variant }}" >> "$GITHUB_ENV"

      - name: Package Windows artifact
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ('${{ matrix.build_variant }}' -eq 'ai') {
            $variantLabel = 'AI'
            $sourceDir = 'dist\mp3paramidi-ai'
          } else {
            $variantLabel = 'Standard'
            $sourceDir = 'dist\mp3paramidi-standard'
          }
          $sourceExe = Join-Path $sourceDir 'mp3paramidi.exe'
          if (-not (Test-Path $sourceExe)) {
            throw "Expected executable not found: $sourceExe"
          }
          $dest = "dist/MP3paraMIDI-v${{ env.APP_VERSION }}-Windows-$variantLabel.exe"
          Copy-Item $sourceExe $dest -Force
          "ARTIFACT_FILE=$dest" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ARTIFACT_NAME=MP3paraMIDI-${{ matrix.os }}-${{ matrix.build_variant }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_FILE }}

  release:
    name: Release
    needs: build
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          draft: false
          files: |
            artifacts/**/MP3paraMIDI-v${{ env.APP_VERSION }}-Windows-Standard.exe
            artifacts/**/MP3paraMIDI-v${{ env.APP_VERSION }}-macOS-Standard.dmg
            artifacts/**/MP3paraMIDI-v${{ env.APP_VERSION }}-macOS-AI.dmg
            artifacts/**/MP3paraMIDI-v${{ env.APP_VERSION }}-Linux-Standard-x86_64.AppImage
            artifacts/**/MP3paraMIDI-v${{ env.APP_VERSION }}-Linux-AI-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
