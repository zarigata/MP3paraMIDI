name: Test Builds

on:
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "build_configs/**"
      - ".github/workflows/test-builds.yml"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  APP_VERSION: "0.1.0"

jobs:
  smoke-test:
    name: Smoke Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, windows-2025, macos-15]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt pyinstaller

      - name: Install icon tooling (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y inkscape imagemagick fuse

      - name: Install icon tooling (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install --cask inkscape
          brew install imagemagick

      - name: Install icon tooling (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install -y inkscape imagemagick

      - name: Generate icons (POSIX)
        if: runner.os != 'Windows'
        run: bash tools/build_icons.sh

      - name: Generate icons (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./tools/build_icons.ps1

      - name: Build standard variant
        run: pyinstaller build_configs/mp3paramidi.spec
        shell: bash
        if: runner.os != 'Windows'

      - name: Build standard variant (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: pyinstaller build_configs/mp3paramidi.spec

      - name: Linux AppImage smoke test
        if: runner.os == 'Linux'
        run: |
          bash build_configs/linux/build_appimage.sh dist/mp3paramidi-standard dist ${{ env.APP_VERSION }} standard
          chmod +x dist/MP3paraMIDI-v${{ env.APP_VERSION }}-Linux-Standard-x86_64.AppImage
          ./dist/MP3paraMIDI-v${{ env.APP_VERSION }}-Linux-Standard-x86_64.AppImage --appimage-extract >/dev/null

      - name: macOS bundle verification
        if: runner.os == 'macOS'
        run: |
          codesign --verify --deep dist/MP3paraMIDI.app || true
          ls dist/MP3paraMIDI.app

      - name: Windows executable verification
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Get-ChildItem dist -Filter 'mp3paramidi.exe' -Recurse

      - name: Upload smoke-test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mp3paramidi-test-${{ matrix.os }}
          path: dist
          retention-days: 7
